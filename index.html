<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Prompts Galerie</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
:root { --img-height: 240px; }

body {
    font-family: Arial, sans-serif;
    background: #2b2b2b;
    color: #e0e0e0;
    margin: 20px;
}

.controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}

button {
    background: #444;
    color: #fff;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
}

button:hover { background: #555; }

.gallery {
    display: flex;
    flex-wrap: wrap;
}

.gallery img {
    height: var(--img-height);
    cursor: pointer;
}

/* Toast */
.toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,.85);
    padding: 10px 15px;
    border-radius: 4px;
    opacity: 0;
    transition: .3s;
    z-index: 1000;
}
.toast.show { opacity: 1; }

/* Modal prompt */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.modal.show { display: flex; }

.modal-content {
    background: #1e1e1e;
    padding: 20px;
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    overflow: auto;
    border-radius: 6px;
    white-space: pre-wrap;
    font-family: Consolas, monospace;
}

.modal-content button {
    margin-top: 15px;
}
</style>
</head>

<body>

<h1>Prompts Galerie</h1>

<div class="controls">
    <input type="file" id="folderInput" webkitdirectory multiple>
    <button id="zoomIn">+</button>
    <button id="zoomOut">-</button>
    <button id="exportZip">Exporter ZIP serveur</button>
    <button id="showPrompt">Afficher le prompt</button>
</div>

<div class="gallery" id="gallery"></div>
<div class="toast" id="toast"></div>

<!-- Modal affichage prompt -->
<div class="modal" id="promptModal">
    <div class="modal-content">
        <div id="promptContent"></div>
        <button id="closeModal">Fermer</button>
    </div>
</div>

<script>
const gallery = document.getElementById("gallery");
const folderInput = document.getElementById("folderInput");
const toast = document.getElementById("toast");

const modal = document.getElementById("promptModal");
const promptContent = document.getElementById("promptContent");

let imageHeight = 240;
let serverImages = null;
let lastCopiedPrompt = "";   // ? mémoire du prompt

document.documentElement.style.setProperty('--img-height', imageHeight + 'px');

zoomIn.onclick = () => {
    imageHeight *= 1.2;
    document.documentElement.style.setProperty('--img-height', imageHeight + 'px');
};

zoomOut.onclick = () => {
    imageHeight /= 1.2;
    document.documentElement.style.setProperty('--img-height', imageHeight + 'px');
};

function showToast(message) {
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 1800);
}

/* =======================
   MODE SERVEUR
======================= */
async function loadGalerieFromServer() {
    try {
        const res = await fetch("Galerie/galerie.json", { cache: "no-store" });
        if (!res.ok) throw "absent";

        const data = await res.json();
        if (!data.images?.length) throw "vide";

        serverImages = data.images;
        gallery.innerHTML = "";

        for (const name of serverImages) {
            const img = document.createElement("img");
            img.src = "Galerie/" + name;

            const base = name.replace(/\.(png|jpg|jpeg)$/i, "");
            img.onclick = async () => {
                const r = await fetch("Galerie/" + base + ".txt");
                if (!r.ok) {
                    showToast("Il manque le prompt.");
                    return;
                }
                const text = await r.text();
                await navigator.clipboard.writeText(text);
                lastCopiedPrompt = text;
                showToast("Prompt copié");
            };

            gallery.appendChild(img);
        }
        return true;
    } catch {
        return false;
    }
}

/* =======================
   MODE LOCAL
======================= */
folderInput.onchange = () => {
    gallery.innerHTML = "";
    serverImages = null;

    const files = Array.from(folderInput.files);
    const texts = {};

    files.forEach(f => {
        if (f.name.endsWith(".txt")) {
            texts[f.name.replace(".txt","")] = f;
        }
    });

    files.forEach(f => {
        if (f.type.startsWith("image/")) {
            const img = document.createElement("img");
            img.src = URL.createObjectURL(f);

            const base = f.name.replace(/\.(png|jpg|jpeg)$/i,"");
            img.onclick = async () => {
                if (!texts[base]) {
                    showToast("Il manque le prompt.");
                    return;
                }
                const text = await texts[base].text();
                await navigator.clipboard.writeText(text);
                lastCopiedPrompt = text;
                showToast("Prompt copié");
            };

            gallery.appendChild(img);
        }
    });
};

/* =======================
   EXPORT ZIP (LOCAL + SERVEUR)
======================= */
exportZip.onclick = async () => {
    const zip = new JSZip();
    const galerie = zip.folder("Galerie");

    if (serverImages) {
        const json = {
            generated: new Date().toISOString(),
            images: serverImages
        };

        galerie.file("galerie.json", JSON.stringify(json, null, 2));

        for (const name of serverImages) {
            const imgRes = await fetch("Galerie/" + name);
            galerie.file(name, await imgRes.arrayBuffer(), { binary: true });

            const base = name.replace(/\.(png|jpg|jpeg)$/i, "");
            const txtRes = await fetch("Galerie/" + base + ".txt");
            if (txtRes.ok) {
                galerie.file(base + ".txt", await txtRes.arrayBuffer(), { binary: true });
            }
        }
    }
    else if (folderInput.files.length) {
        const files = Array.from(folderInput.files);

        const json = {
            generated: new Date().toISOString(),
            images: files.filter(f => f.type.startsWith("image/")).map(f => f.name).sort()
        };

        galerie.file("galerie.json", JSON.stringify(json, null, 2));

        for (const f of files) {
            if (f.type.startsWith("image/") || f.name.endsWith(".txt")) {
                galerie.file(f.name, await f.arrayBuffer(), { binary: true });
            }
        }
    }
    else {
        showToast("Aucune galerie disponible.");
        return;
    }

    const blob = await zip.generateAsync({ type: "blob" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "galerie_serveur.zip";
    a.click();
    URL.revokeObjectURL(a.href);
};

/* =======================
   AFFICHER LE PROMPT
======================= */
showPrompt.onclick = () => {
    if (!lastCopiedPrompt) {
        showToast("Aucun prompt copié.");
        return;
    }
    promptContent.textContent = lastCopiedPrompt;
    modal.classList.add("show");
};

closeModal.onclick = () => {
    modal.classList.remove("show");
};

/* =======================
   INIT
======================= */
window.addEventListener("DOMContentLoaded", async () => {
    const ok = await loadGalerieFromServer();
    if (!ok) console.log("Mode local actif");
});
</script>

</body>
</html>
