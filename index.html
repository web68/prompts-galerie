<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Prompts Galerie</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
:root { --img-height: 240px; }

body {
    font-family: Arial, sans-serif;
    background: #2b2b2b;
    color: #e0e0e0;
    margin: 20px;
}

.controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 15px;
}

button {
    background: #444;
    color: #fff;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
}

button:hover { background: #555; }

.gallery {
    display: flex;
    flex-wrap: wrap;
}

.gallery img {
    height: var(--img-height);
    cursor: pointer;
}

/* Toast */
.toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,.85);
    padding: 10px 15px;
    border-radius: 4px;
    opacity: 0;
    transition: .3s;
    z-index: 1000;
}
.toast.show { opacity: 1; }

/* Modal */
.modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.65);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.modal.show { display: flex; }

.modal-content {
    background: #1e1e1e;
    padding: 20px;
    max-width: 900px;
    width: 90%;
    max-height: 85vh;
    overflow: auto;
    border-radius: 6px;
}

.modal-header {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 10px;
}

.section {
    margin-top: 15px;
}

.section h3 {
    margin-bottom: 6px;
    font-size: 14px;
    color: #aaa;
}

pre {
    background: #111;
    padding: 10px;
    white-space: pre-wrap;
    border-radius: 4px;
    font-family: Consolas, monospace;
}

.modal-buttons {
    margin-top: 15px;
    display: flex;
    gap: 10px;
}
</style>
</head>

<body>

<h1>Prompts Galerie</h1>

<div class="controls">
    <input type="file" id="folderInput" webkitdirectory multiple>
    <button id="zoomIn">+</button>
    <button id="zoomOut">−</button>
    <button id="exportZip">Exporter ZIP serveur</button>
</div>

<div class="gallery" id="gallery"></div>
<div class="toast" id="toast"></div>

<!-- MODAL PROMPT -->
<div class="modal" id="promptModal">
    <div class="modal-content">
        <div class="modal-header" id="modalTitle"></div>

        <div class="section">
            <h3>Prompt</h3>
            <pre id="promptText"></pre>
        </div>

        <div class="section" id="helpSection" style="display:none;">
            <h3>Aide</h3>
            <pre id="helpText"></pre>
        </div>

        <div class="modal-buttons">
            <button id="copyPrompt">Copier</button>
            <button id="closeModal">Fermer</button>
        </div>
    </div>
</div>

<script>
const gallery = document.getElementById("gallery");
const folderInput = document.getElementById("folderInput");
const toast = document.getElementById("toast");

const modal = document.getElementById("promptModal");
const modalTitle = document.getElementById("modalTitle");
const promptText = document.getElementById("promptText");
const helpSection = document.getElementById("helpSection");
const helpText = document.getElementById("helpText");

let imageHeight = 240;
let serverImages = null;
let currentPrompt = "";

document.documentElement.style.setProperty('--img-height', imageHeight + 'px');

zoomIn.onclick = () => {
    imageHeight *= 1.2;
    document.documentElement.style.setProperty('--img-height', imageHeight + 'px');
};

zoomOut.onclick = () => {
    imageHeight /= 1.2;
    document.documentElement.style.setProperty('--img-height', imageHeight + 'px');
};

function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 1800);
}

function openModal(title, prompt, help) {
    modalTitle.textContent = title;
    promptText.textContent = prompt;
    currentPrompt = prompt;

    if (help) {
        helpText.textContent = help;
        helpSection.style.display = "block";
    } else {
        helpSection.style.display = "none";
    }

    modal.classList.add("show");
}

function closeModal() {
    modal.classList.remove("show");
}

closeModalBtn = document.getElementById("closeModal");
closeModalBtn.onclick = closeModal;

copyPrompt.onclick = async () => {
    await navigator.clipboard.writeText(currentPrompt);
    showToast("Prompt copié");
};

window.addEventListener("keydown", e => {
    if (e.key === "Escape" && modal.classList.contains("show")) {
        closeModal();
    }
});

/* =======================
   MODE SERVEUR
======================= */
async function loadGalerieFromServer() {
    try {
        const res = await fetch("Galerie/galerie.json", { cache: "no-store" });
        if (!res.ok) throw "absent";

        const data = await res.json();
        if (!data.images?.length) throw "vide";

        serverImages = data.images;
        gallery.innerHTML = "";

        for (const name of serverImages) {
            const img = document.createElement("img");
            img.src = "Galerie/" + name;

            img.onclick = async () => {
                const base = name.replace(/\.(png|jpg|jpeg)$/i, "");

                const txtRes = await fetch("Galerie/" + base + ".txt");
                if (!txtRes.ok) {
                    showToast("Il manque le prompt.");
                    return;
                }

                const prompt = await txtRes.text();
                await navigator.clipboard.writeText(prompt);

                let help = null;
                const hlpRes = await fetch("Galerie/" + base + ".hlp");
                if (hlpRes.ok) help = await hlpRes.text();

                openModal(base, prompt, help);
            };

            gallery.appendChild(img);
        }
        return true;
    } catch {
        return false;
    }
}

/* =======================
   MODE LOCAL
======================= */
folderInput.onchange = () => {
    gallery.innerHTML = "";
    serverImages = null;

    const files = Array.from(folderInput.files);
    const texts = {};
    const helps = {};

    files.forEach(f => {
        const base = f.name.replace(/\.(txt|hlp)$/i, "");
        if (f.name.endsWith(".txt")) texts[base] = f;
        if (f.name.endsWith(".hlp")) helps[base] = f;
    });

    files.forEach(f => {
        if (f.type.startsWith("image/")) {
            const img = document.createElement("img");
            img.src = URL.createObjectURL(f);

            const base = f.name.replace(/\.(png|jpg|jpeg)$/i,"");

            img.onclick = async () => {
                if (!texts[base]) {
                    showToast("Il manque le prompt.");
                    return;
                }

                const prompt = await texts[base].text();
                await navigator.clipboard.writeText(prompt);

                const help = helps[base] ? await helps[base].text() : null;
                openModal(base, prompt, help);
            };

            gallery.appendChild(img);
        }
    });
};

/* =======================
   INIT
======================= */
window.addEventListener("DOMContentLoaded", async () => {
    const ok = await loadGalerieFromServer();
    if (!ok) console.log("Mode local actif");
});
</script>

</body>
</html>
